# Testing Guide

This guide covers how to run tests locally, what to expect from coverage gates, and how to troubleshoot common issues.

## Running tests

- Single module (addon-sdk):

```
mvn -e -DtrimStackTrace=false -pl addons/addon-sdk -am test
```

- Single test class or method:

```
mvn -e -DtrimStackTrace=false -pl addons/addon-sdk -Dtest=PathSanitizerTest test
mvn -e -DtrimStackTrace=false -pl addons/addon-sdk -Dtest=PathSanitizerTest#testSanitize_RejectsNullBytes test
```

- Full reactor:

```
mvn -e -DtrimStackTrace=false -fae verify
```

### Smoke tests (fast uptime check)

Smoke tests boot each addâ€‘on on a random port and verify that `/health` and `/metrics` respond with 200.

- Run all smoke tests:
  - `make smoke` (installs sdk locally, then runs per-module SmokeIT)
  - or:
    - `mvn -q -pl addons/addon-sdk -am -DskipTests install`
    - `mvn -e -f addons/auto-tag-assistant/pom.xml -Dtest=*SmokeIT test`
    - `mvn -e -f addons/rules/pom.xml -Dtest=*SmokeIT test`
    - `mvn -e -f addons/overtime/pom.xml -Dtest=*SmokeIT test`

These tests are also executed in CI via `.github/workflows/smoke.yml` for quick feedback on basic runtime wiring.

## Coverage gates

JaCoCo is bound so `verify` always has execution data. Coverage thresholds are intentionally scoped to tested packages so we can iterate without blocking.

- `addons/addon-sdk`:
  - `com.clockify.addon.sdk.util` â€” INSTRUCTION â‰¥ 0.60
  - `com.clockify.addon.sdk.middleware` â€” INSTRUCTION â‰¥ 0.50

- `addons/rules` (bundle) â€” INSTRUCTION â‰¥ 0.40

CI publishes aggregate coverage to Pages (see README for link). The docs job uses `-Djacoco.skip=true` because it doesnâ€™t run tests.

## JSON error shapes

Errors returned by the SDK convenience helpers are JSON bodies, not plain text. For example, webhook signature errors look like:

```json
{"error":"signature header missing"}
{"error":"invalid signature"}
```

Update downstream tests to parse JSON bodies when asserting failures.

## Lifecycle vs Webhook routing

The SDK does not treat lifecycle endpoints as webhooks. Use explicit registration:

```java
addon.registerLifecycleHandler("INSTALLED", "/lifecycle/installed", request -> HttpResponse.ok("{}","application/json"));
```

Posting to `/lifecycle/installed` is dispatched to the handler-by-path. The servlet does not pre-parse JSON for explicit lifecycle paths; your handler can read the body via `clockify.rawBody` or `request.getReader()`.

## Coverage badge on Pages

The Pages workflow publishes `docs/coverage/` including `jacoco.xml` (if present), a simple `summary.json`, and `badge.svg` generated by `tools/coverage_badge.py`.

- Source of truth: the Pages job fetches the latest `jacoco-aggregate` artifact created by the `build-and-test` workflow and generates the badge from that report. This keeps the badge current without running tests in the docs job.
- If no coverage artifact is available for the deploy (e.g., artifacts expired or a docs-only branch), the badge falls back to `N/A`.
- Ordering: Pages deploy runs automatically after `build-and-test` succeeds on `main` (or when manually triggered), and it checks out the exact commit that was tested.

## Coverage comment on Pull Requests

The build-and-test workflow computes a simple coverage summary and posts a one-line comment on PRs:

- It prefers the aggregate report at `target/site/jacoco-aggregate/jacoco.xml` (if present),
  otherwise it falls back to `addons/addon-sdk/target/site/jacoco/jacoco.xml`.
- The comment shows `ðŸ§ª Coverage summary: <percent>%` or `N/A` if no report exists for that run.

Additionally, it fetches the current baseline coverage from the published Pages summary for `main` and computes a delta:

- Baseline URL: `https://apet97.github.io/boileraddon/coverage/summary.json`
- The PR comment includes current, baseline, and delta in percentage points (pp) when both are available.

## Troubleshooting

- Ensure youâ€™re on Java 17 for both Maven and the forked test JVM (see docs/BUILD_ENVIRONMENT.md). Newer JDKs can cause the test JVM to die or Mockito to fail.
- Clear tool caches when switching JDKs:

```
rm -rf ~/.m2/repository/org/jacoco ~/.m2/repository/org/apache/maven/surefire
```

- On newer JDKs locally, if Mockito fails to mock classes, use the subclass mock-maker under `src/test/resources/mockito-extensions` and (optionally) set `net.bytebuddy.experimental=true` in Surefire.

## DB Integration Tests (PostgreSQL)

When testing JDBC-backed stores, prefer Testcontainers to run against a real PostgreSQL:

```
<dependencies>
  <dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.20.2</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <version>1.20.2</version>
    <scope>test</scope>
  </dependency>
</dependencies>
```

See `DatabaseTokenStoreIT` in `addons/addon-sdk` for a concrete example. CI runs on GitHub Actions with Docker available, so Testcontainers works out of the box.
