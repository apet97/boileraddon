package com.example.rules;

import com.clockify.addon.sdk.*;
import com.clockify.addon.sdk.security.TokenStore;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.IOException;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.net.ServerSocket;

/**
 * Embedded server smoke tests for all CRUD endpoints (Projects, Clients, Tasks, Tags).
 * Verifies that all endpoints are properly registered and respond to basic requests.
 */
// Temporarily disabled due to compilation issues - will be fixed in separate commit
// @Disabled("Temporarily disabled - needs controller registration fixes")
class CrudEndpointsSmokeIT {
    private EmbeddedServer server;
    private Thread serverThread;
    private int port;
    private String baseUrl;
    private HttpClient client;

    @BeforeEach
    void setUp() throws Exception {
        this.port = randomPort();
        this.baseUrl = "http://localhost:" + port + "/rules";
        this.client = HttpClient.newHttpClient();

        // Setup test workspace token
        String testWorkspaceId = "test-workspace-smoke";
        String testToken = "test-token-smoke";
        String testApiBaseUrl = "https://api.clockify.me";
        TokenStore.save(testWorkspaceId, testToken, testApiBaseUrl);

        ClockifyManifest manifest = ClockifyManifest
                .v1_3Builder()
                .key("rules")
                .name("Rules (CRUD Smoke Test)")
                .baseUrl(baseUrl)
                .minimalSubscriptionPlan("FREE")
                .scopes(new String[]{"projects:read", "clients:read", "tasks:read", "tags:read"})
                .build();

        ClockifyAddon addon = new ClockifyAddon(manifest);

        // Create mock ClockifyClient for controllers
        ClockifyClient mockClient = new ClockifyClient("https://api.clockify.me/api/v1", "test-token");

        // Register all controllers
        addon.registerCustomEndpoint("/api/projects", new ProjectsController(mockClient));
        addon.registerCustomEndpoint("/api/clients", new ClientsController(mockClient));
        addon.registerCustomEndpoint("/api/tasks", new TasksController(mockClient));
        addon.registerCustomEndpoint("/api/tags", new TagsController(mockClient));

        // Create mock RulesStoreSPI for RulesController
        com.example.rules.store.RulesStoreSPI mockRulesStore = new com.example.rules.store.DatabaseRulesStore();
        addon.registerCustomEndpoint("/api/rules", new RulesController(mockRulesStore));

        AddonServlet servlet = new AddonServlet(addon);
        server = new EmbeddedServer(servlet, "/rules");
        serverThread = new Thread(() -> {
            try {
                server.start(port);
            } catch (Exception ignored) {}
        });
        serverThread.start();

        // Wait for server to be ready
        awaitReady(client, URI.create(baseUrl + "/health"));
    }

    @AfterEach
    void tearDown() throws Exception {
        if (server != null) server.stop();
        if (serverThread != null) serverThread.join(2000);

        // Clean up test token
        TokenStore.delete("test-workspace-smoke");
    }

    @Test
    void projectsEndpointResponds() throws Exception {
        String workspaceId = "test-workspace-smoke";

        // Test GET /api/projects
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/api/projects?workspaceId=" + workspaceId))
                .GET()
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        // Should return 200 or 403 (if no actual token in test environment)
        assert response.statusCode() == 200 || response.statusCode() == 403 :
            "Projects endpoint should respond with 200 or 403, got: " + response.statusCode();
    }

    @Test
    void clientsEndpointResponds() throws Exception {
        String workspaceId = "test-workspace-smoke";

        // Test GET /api/clients
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/api/clients?workspaceId=" + workspaceId))
                .GET()
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        // Should return 200 or 403 (if no actual token in test environment)
        assert response.statusCode() == 200 || response.statusCode() == 403 :
            "Clients endpoint should respond with 200 or 403, got: " + response.statusCode();
    }

    @Test
    void tasksEndpointResponds() throws Exception {
        String workspaceId = "test-workspace-smoke";

        // Test GET /api/tasks
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/api/tasks?workspaceId=" + workspaceId))
                .GET()
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        // Should return 200 or 403 (if no actual token in test environment)
        assert response.statusCode() == 200 || response.statusCode() == 403 :
            "Tasks endpoint should respond with 200 or 403, got: " + response.statusCode();
    }

    @Test
    void tagsEndpointResponds() throws Exception {
        String workspaceId = "test-workspace-smoke";

        // Test GET /api/tags
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/api/tags?workspaceId=" + workspaceId))
                .GET()
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        // Should return 200 or 403 (if no actual token in test environment)
        assert response.statusCode() == 200 || response.statusCode() == 403 :
            "Tags endpoint should respond with 200 or 403, got: " + response.statusCode();
    }

    @Test
    void rulesEndpointResponds() throws Exception {
        String workspaceId = "test-workspace-smoke";

        // Test GET /api/rules
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(baseUrl + "/api/rules?workspaceId=" + workspaceId))
                .GET()
                .build();

        HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

        // Should return 200 or 403 (if no actual token in test environment)
        assert response.statusCode() == 200 || response.statusCode() == 403 :
            "Rules endpoint should respond with 200 or 403, got: " + response.statusCode();
    }

    @Test
    void allCrudEndpointsRegistered() throws Exception {
        String[] endpoints = {
            "/api/projects",
            "/api/clients",
            "/api/tasks",
            "/api/tags",
            "/api/rules"
        };

        for (String endpoint : endpoints) {
            HttpRequest request = HttpRequest.newBuilder()
                    .uri(URI.create(baseUrl + endpoint))
                    .method("OPTIONS", HttpRequest.BodyPublishers.noBody())
                    .build();

            HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());

            // OPTIONS should return 200 with Allow header
            assert response.statusCode() == 200 :
                "Endpoint " + endpoint + " should respond to OPTIONS, got: " + response.statusCode();
            assert response.headers().firstValue("Allow").isPresent() :
                "Endpoint " + endpoint + " should have Allow header";
        }
    }

    private static void awaitReady(HttpClient client, URI uri) throws InterruptedException {
        long deadline = System.currentTimeMillis() + 5000;
        while (System.currentTimeMillis() < deadline) {
            try {
                HttpResponse<Void> r = client.send(HttpRequest.newBuilder(uri).GET().build(), HttpResponse.BodyHandlers.discarding());
                if (r.statusCode() == 200) return;
            } catch (Exception ignored) {}
            Thread.sleep(100);
        }
    }

    private static int randomPort() throws IOException {
        try (ServerSocket socket = new ServerSocket(0)) { return socket.getLocalPort(); }
    }
}