name: Validate and Test

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyjwt

      - name: Validate manifest
        run: |
          python tools/validate-manifest.py

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run tests
        run: mvn test

      - name: Build addon-sdk
        run: mvn -pl addons/addon-sdk package

      - name: Build auto-tag-assistant
        run: mvn -pl addons/auto-tag-assistant package

      - name: Verify JAR files
        run: |
          ls -lh addons/addon-sdk/target/*.jar
          ls -lh addons/auto-tag-assistant/target/*.jar

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
            **/target/failsafe-reports/*.xml

      - name: Upload coverage reports
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            **/target/site/jacoco/**/*


  lifecycle-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Validate addons via script (manifest, lifecycle, security)
        run: |
          bash tools/validate-addon.sh addons/_template-addon || true
          bash tools/validate-addon.sh addons/auto-tag-assistant || true
          bash tools/validate-addon.sh addons/rules || true
          bash tools/validate-addon.sh addons/overtime || true
