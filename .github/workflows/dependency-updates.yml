name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      dependency_type:
        description: 'Type of dependency to update'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - security
        - test

jobs:
  dependency-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Check for dependency updates
      run: |
        echo "Checking for dependency updates..."
        mvn versions:display-dependency-updates versions:display-plugin-updates -q

    - name: Security vulnerability scan
      run: |
        echo "Running OWASP dependency check..."
        mvn org.owasp:dependency-check-maven:check -Psecurity-scan -q

    - name: Generate dependency update report
      run: |
        echo "## Dependency Update Report" > dependency-report.md
        echo "Generated: $(date)" >> dependency-report.md
        echo "" >> dependency-report.md
        echo "### Available Updates" >> dependency-report.md
        echo "" >> dependency-report.md
        mvn versions:display-dependency-updates -q 2>/dev/null | grep -E "(->|The following dependencies|\[INFO\])" | sed 's/\[INFO\]//g' >> dependency-report.md

        echo "" >> dependency-report.md
        echo "### Plugin Updates" >> dependency-report.md
        echo "" >> dependency-report.md
        mvn versions:display-plugin-updates -q 2>/dev/null | grep -E "(->|The following plugins|\[INFO\])" | sed 's/\[INFO\]//g' >> dependency-report.md

    - name: Upload dependency report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-update-report
        path: dependency-report.md
        retention-days: 30

    - name: Comment on issue if updates available
      if: github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('dependency-report.md', 'utf8');

          // Create or update issue with dependency updates
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['dependencies', 'automated']
          });

          const existingIssue = issues.find(issue => issue.title.includes('Dependency Update Report'));

          if (existingIssue) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: report
            });
          } else {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Dependency Update Report - ' + new Date().toISOString().split('T')[0],
              body: report,
              labels: ['dependencies', 'automated', 'maintenance']
            });
          }

  auto-merge-dependabot:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'

    steps:
    - name: Enable auto-merge for Dependabot PRs
      if: contains(github.event.pull_request.labels.*.name, 'dependencies') && !contains(github.event.pull_request.labels.*.name, 'security')
      run: |
        echo "Auto-merging safe dependency updates..."
        # This would require additional permissions and setup
        # For now, just log the intention
        echo "PR #${{ github.event.pull_request.number }} is eligible for auto-merge"

    - name: Security update notification
      if: contains(github.event.pull_request.labels.*.name, 'security')
      run: |
        echo "Security update detected - requires manual review"
        echo "PR #${{ github.event.pull_request.number }} contains security updates"

  test-updated-dependencies:
    name: Test Updated Dependencies
    runs-on: ubuntu-latest
    needs: dependency-updates
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Update dependencies to latest
      run: |
        echo "Updating dependencies to latest versions..."
        mvn versions:use-latest-versions -DgenerateBackupPoms=false -q

    - name: Run tests with updated dependencies
      run: |
        echo "Running tests with updated dependencies..."
        mvn clean test -q

    - name: Report test results
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "✅ All tests pass with updated dependencies"
        else
          echo "❌ Tests failed with updated dependencies - manual review required"
        fi